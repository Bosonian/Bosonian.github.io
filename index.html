<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iGFAP Check</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background-color: #f8f9fa; }
        .container { max-width: 500px; margin: 70px auto 20px auto; padding: 20px; background-color: white; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; }
        .input-group input { width: calc(100% - 24px); padding: 12px; font-size: 18px; border: 2px solid #007bff; border-radius: 5px; }
        .button-group { margin-top: 20px; }
        button { padding: 12px; margin-top: 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .primary { background-color: #007bff; color: white; width: 100%; }
        .primary:hover { background-color: #0056b3; }
        .secondary { background-color: #dc3545; color: white; width: 100%; }
        .secondary:hover { background-color: #b52b3a; }
        .result { margin-top: 1.5rem; padding: 1rem; border-radius: 8px; font-size: 18px; font-weight: bold; display: none; text-align: center; }
        .low-risk { color: green; }
        .medium-risk { color: orange; }
        .high-risk { color: red; }
        .very-high-risk { color: red; }
        .warning { font-size: 12px; color: red; margin-top: 10px; }
        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background-color: #007bff; color: white; position: sticky; top: 0; z-index: 999; }
        .header-left h1 { margin: 0; font-size: 20px; }
        .header-right { display: flex; align-items: center; }
        .language-switcher button { background: none; border: none; color: white; padding: 5px; margin-right: 10px; cursor: pointer; border-radius: 4px; }
        .language-switcher button img { width: 24px; height: 16px; }
        .home-button { background: white; color: #007bff; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .home-button:hover { background-color: #f2f2f2; }
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fff; margin: 20% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; border-radius: 10px; text-align: center; }
        .checkbox-group { margin-bottom: 15px; text-align: left; }
        .checkbox-group input { margin-right: 10px; }
        .install-icons { display: flex; justify-content: center; margin-top: 20px; }
        .install-icons img { width: 40px; height: 40px; margin: 0 10px; cursor: pointer; }
        .module-subtext { font-size: 12px; color: #666; margin-top: 5px; }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="header-left">
            <h1 id="appTitle">iGFAP Check</h1>
        </div>
        <div class="header-right">
            <div class="language-switcher">
                <button onclick="switchLanguage('en')"><img src="https://flagcdn.com/gb.svg" alt="English"></button>
                <button onclick="switchLanguage('de')"><img src="https://flagcdn.com/de.svg" alt="Deutsch"></button>
            </div>
            <button class="home-button" onclick="restartApp()">üè† Home</button>
        </div>
    </header>

    <!-- Access Code Screen -->
    <section id="codeEntrySection" class="container">
        <p id="codePrompt">üîë Please enter your access code:</p>
        <input type="password" id="accessCodeInput" placeholder="Enter code">
        <button class="primary" onclick="validateAccessCode()">Submit</button>
        <p id="accessError" class="warning" style="display: none;">Incorrect code. Please try again.</p>
    </section>

    <!-- Module Selection Screen -->
    <section id="moduleSelectionSection" class="container" style="display:none;">
        <h2 id="moduleSelectionTitle">Select Module</h2>
        <button class="primary" onclick="startComaModule()" id="comaModuleButton">üß† Intracranial Bleeding Risk in Coma</button>
        <p class="module-subtext">COMA (GCS 3-8)</p>
        <button class="primary" onclick="startStrokeModule()" id="strokeModuleButton">ü©∫ Intracerebral Bleeding Risk in Patients with Stroke Symptoms</button>
        <p class="module-subtext">Stroke</p>
    </section>

    <!-- Coma Module Section -->
    <section id="comaModuleSection" class="container" style="display:none;">
        <h2 id="comaModuleTitle">Intracranial Bleeding Risk in Coma</h2>
        <div class="input-group">
            <label for="gfapComaInput">GFAP Value (pg/mL)</label>
            <input type="number" id="gfapComaInput" min="29" max="10001">
        </div>
        <button class="primary" onclick="calculateComaRisk()">Calculate Risk</button>
        <div class="result" id="comaResult"></div>
    </section>

    <!-- Stroke Prerequisite Screen -->
    <section id="strokePrerequisiteSection" class="container" style="display:none;">
        <h2 id="strokePrerequisiteTitle">Prerequisites for Stroke Risk Calculation</h2>
        <div class="checkbox-group">
            <input type="checkbox" id="prerequisite1">
            <label for="prerequisite1" id="prerequisite1Label">Gesichertes Zeitfenster < 6 Stunden</label>
        </div>
        <div class="checkbox-group">
            <input type="checkbox" id="prerequisite2">
            <label for="prerequisite2" id="prerequisite2Label">Keine neurologische Defizite in den Stunden / Tagen vor dem Ereignis</label>
        </div>
        <div class="checkbox-group">
            <input type="checkbox" id="prerequisite3">
            <label for="prerequisite3" id="prerequisite3Label">Kein erkennbares Sch√§del Hirn Trauma (schwerer Sturz)</label>
        </div>
        <div class="checkbox-group">
            <input type="checkbox" id="prerequisite4">
            <label for="prerequisite4" id="prerequisite4Label">FAST ED Score >= 3 Punkte</label>
        </div>
        <button class="primary" id="proceedButton" onclick="validatePrerequisites()">Proceed to Calculation</button>
        <p id="prerequisiteError" class="warning" style="display: none;">Please confirm all prerequisites before proceeding.</p>
    </section>

    <!-- Stroke Module Section -->
    <section id="strokeModuleSection" class="container" style="display:none;">
        <h2 id="strokeModuleTitle">Intracerebral Bleeding Risk in Patients with Stroke Symptoms</h2>
        <div class="input-group">
            <label for="ageInput">Patient Age (Years)</label>
            <input type="number" id="ageInput" min="1" max="120">
        </div>
        <div class="input-group">
            <label for="gfapStrokeInput">GFAP Value (pg/mL)</label>
            <input type="number" id="gfapStrokeInput" min="0" max="10001"> <!-- Removed lower limit -->
        </div>
        <button class="primary" id="calculateStrokeButton" onclick="calculateStrokeRisk()">Calculate Risk</button>
        <div class="result" id="strokeResult"></div>
    </section>

    <!-- Installation Icons -->
    <div class="install-icons" id="installIcons">
        <!-- Icons will be dynamically added here based on the OS -->
    </div>

    <footer style="text-align: center; margin-top: 20px;">
        <p>¬© <span id="currentYear"></span> iGFAP. All rights reserved.</p>
    </footer>

    <script>
        let currentLang = 'en';

        // Language translations
        const translations = {
            en: {
                appTitle: "iGFAP Check",
                codePrompt: "üîë Please enter your access code:",
                moduleSelectionTitle: "Select Module",
                comaModuleTitle: "üß† Intracranial Bleeding Risk in Coma",
                strokeModuleTitle: "ü©∫ Intracerebral Bleeding Risk in Patients with Stroke Symptoms",
                strokePrerequisiteTitle: "Prerequisites for Stroke Risk Calculation",
                accessError: "Incorrect code. Please try again.",
                comaRiskTitle: "Intracranial Bleeding Risk in Coma",
                strokeRiskTitle: "Intracerebral Bleeding Risk in Patients with Stroke Symptoms",
                calculateButton: "Calculate Risk",
                proceedButton: "Proceed to Calculation",
                invalidInput: "Please enter a valid value!",
                lowRisk: "Low Risk",
                mediumRisk: "Medium Risk",
                highRisk: "High Risk",
                veryHighRisk: "Very High Risk",
                prerequisite1: "Confirmed time window < 6 hours",
                prerequisite2: "No neurological deficits in the hours/days before the event",
                prerequisite3: "No identifiable head trauma (severe fall)",
                prerequisite4: "FAST ED Score >= 3 points",
                prerequisiteError: "Please confirm all prerequisites before proceeding.",
                disclaimer: "The calculations are for research purposes only, do not make clinical decisions based on it.",
                probability: "Probability",
                riskLevel: "Risk Level",
                interpretation: "Interpretation" // Added translation
            },
            de: {
                appTitle: "iGFAP Check",
                codePrompt: "üîë Bitte geben Sie Ihren Zugangscode ein:",
                moduleSelectionTitle: "Modul ausw√§hlen",
                comaModuleTitle: "üß† Intrakranielle Blutungsrisiko im Koma",
                strokeModuleTitle: "ü©∫ Intrazerebrales Blutungsrisiko bei Patienten mit Schlaganfallsymptomen",
                strokePrerequisiteTitle: "Voraussetzungen f√ºr die Schlaganfallrisikoberechnung",
                accessError: "Falscher Code. Bitte versuchen Sie es erneut.",
                comaRiskTitle: "Intrakranielle Blutungsrisiko im Koma",
                strokeRiskTitle: "Intrazerebrales Blutungsrisiko bei Patienten mit Schlaganfallsymptomen",
                calculateButton: "Risiko berechnen",
                proceedButton: "Zur Berechnung fortfahren",
                invalidInput: "Bitte geben Sie einen g√ºltigen Wert ein!",
                lowRisk: "Geringes Risiko",
                mediumRisk: "Mittleres Risiko",
                highRisk: "Hohes Risiko",
                veryHighRisk: "Sehr hohes Risiko",
                prerequisite1: "Gesichertes Zeitfenster < 6 Stunden",
                prerequisite2: "Keine neurologische Defizite in den Stunden / Tagen vor dem Ereignis",
                prerequisite3: "Kein erkennbares Sch√§del Hirn Trauma (schwerer Sturz)",
                prerequisite4: "FAST ED Score >= 3 Punkte",
                prerequisiteError: "Bitte best√§tigen Sie alle Voraussetzungen, um fortzufahren.",
                disclaimer: "Die Berechnungen dienen nur Forschungszwecken, treffen Sie keine klinischen Entscheidungen basierend darauf.",
                probability: "Wahrscheinlichkeit",
                riskLevel: "Risikostufe",
                interpretation: "Interpretation" // Added translation
            }
        };

        // Stroke risk interpretations (from the uploaded document)
        const strokeInterpretations = {
            en: {
                veryLow: "High probability of cerebral infarction. If FAST ED ‚â• 4, high probability of Large Vessel Occlusion (LVO).",
                low: "Ischemic stroke very likely.",
                intermediate: "Intermediate ICH risk.",
                high: "ICH risk high ~ 85%.",
                veryHigh: "ICH risk very high ~ 91%."
            },
            de: {
                veryLow: "Hohe Wahrscheinlichkeit f√ºr Hirninfarkt. Bei FAST ED ‚â• 4, hohe Wahrscheinlichkeit f√ºr Large Vessel Occlusion (LVO).",
                low: "Isch√§mischer Schlaganfall sehr wahrscheinlich.",
                intermediate: "Intermedi√§r ICH Risiko.",
                high: "ICH Risiko hoch ~ 85%.",
                veryHigh: "ICH Risiko sehr hoch ~ 91%."
            }
        };

        // Show disclaimer dialog
        function showDisclaimer() {
            const disclaimerText = translations[currentLang].disclaimer;
            alert(disclaimerText);
        }

        // Switch language
        function switchLanguage(lang) {
            currentLang = lang;
            const texts = translations[lang];
            document.getElementById('appTitle').innerText = texts.appTitle;
            document.getElementById('codePrompt').innerText = texts.codePrompt;
            document.getElementById('moduleSelectionTitle').innerText = texts.moduleSelectionTitle;
            document.getElementById('comaModuleTitle').innerText = texts.comaRiskTitle;
            document.getElementById('strokeModuleTitle').innerText = texts.strokeRiskTitle;
            document.getElementById('strokePrerequisiteTitle').innerText = texts.strokePrerequisiteTitle;
            document.querySelector('#comaModuleSection button').innerText = texts.calculateButton;
            document.querySelector('#strokeModuleSection button').innerText = texts.calculateButton;
            document.getElementById('proceedButton').innerText = texts.proceedButton;
            document.getElementById('accessError').innerText = texts.accessError;
            document.getElementById('prerequisite1Label').innerText = texts.prerequisite1;
            document.getElementById('prerequisite2Label').innerText = texts.prerequisite2;
            document.getElementById('prerequisite3Label').innerText = texts.prerequisite3;
            document.getElementById('prerequisite4Label').innerText = texts.prerequisite4;
            document.getElementById('prerequisiteError').innerText = texts.prerequisiteError;
            document.getElementById('comaModuleButton').innerText = texts.comaModuleTitle;
            document.getElementById('strokeModuleButton').innerText = texts.strokeModuleTitle;
        }

        // Restart app (navigate to module selection screen)
        function restartApp() {
            document.getElementById('codeEntrySection').style.display = 'none';
            document.getElementById('moduleSelectionSection').style.display = 'block';
            document.getElementById('comaModuleSection').style.display = 'none';
            document.getElementById('strokeModuleSection').style.display = 'none';
            document.getElementById('strokePrerequisiteSection').style.display = 'none';
            document.getElementById('accessCodeInput').value = '';
            document.getElementById('accessError').style.display = 'none';
        }

        // Validate access code
        function validateAccessCode() {
            const accessCode = document.getElementById('accessCodeInput').value.trim();
            const errorElement = document.getElementById('accessError');
            const validCodes = ['1234'];
            if (validCodes.includes(accessCode)) {
                document.getElementById('codeEntrySection').style.display = 'none';
                document.getElementById('moduleSelectionSection').style.display = 'block';
                errorElement.style.display = 'none';
            } else {
                errorElement.innerText = translations[currentLang].accessError;
                errorElement.style.display = 'block';
            }
        }

        // Show coma module
        function startComaModule() {
            document.getElementById('moduleSelectionSection').style.display = 'none';
            document.getElementById('comaModuleSection').style.display = 'block';
        }

        // Show stroke prerequisite screen
        function startStrokeModule() {
            document.getElementById('moduleSelectionSection').style.display = 'none';
            document.getElementById('strokePrerequisiteSection').style.display = 'block';
        }

        // Validate prerequisites
        function validatePrerequisites() {
            const prerequisite1 = document.getElementById('prerequisite1').checked;
            const prerequisite2 = document.getElementById('prerequisite2').checked;
            const prerequisite3 = document.getElementById('prerequisite3').checked;
            const prerequisite4 = document.getElementById('prerequisite4').checked;
            const errorElement = document.getElementById('prerequisiteError');
            if (prerequisite1 && prerequisite2 && prerequisite3 && prerequisite4) {
                document.getElementById('strokePrerequisiteSection').style.display = 'none';
                document.getElementById('strokeModuleSection').style.display = 'block';
                errorElement.style.display = 'none';
            } else {
                errorElement.style.display = 'block';
            }
        }

        // Calculate coma risk
        function calculateComaRisk() {
            showDisclaimer();
            const gfap = parseFloat(document.getElementById('gfapComaInput').value);
            const result = document.getElementById('comaResult');
            if (isNaN(gfap) || gfap < 29 || gfap > 10001) {
                result.innerText = translations[currentLang].invalidInput;
                result.className = 'result warning';
                result.style.display = 'block';
                return;
            }
            const y = 36.72 * Math.log10(gfap) - 50.48;
            const probability = Math.min(Math.max(y, 0), 100);
            let riskLevel = '';
            if (gfap <= 100) riskLevel = translations[currentLang].lowRisk;
            else if (gfap <= 1000) riskLevel = translations[currentLang].mediumRisk;
            else riskLevel = translations[currentLang].highRisk;
            result.innerHTML = `<strong>${translations[currentLang].probability}:</strong> ${probability.toFixed(1)}%<br><strong>${translations[currentLang].riskLevel}:</strong> ${riskLevel}`;
            result.className = 'result ' + (riskLevel === translations[currentLang].lowRisk ? 'low-risk' : riskLevel === translations[currentLang].mediumRisk ? 'medium-risk' : 'high-risk');
            result.style.display = 'block';
        }

        // Calculate stroke risk
        function calculateStrokeRisk() {
            showDisclaimer();
            const age = parseInt(document.getElementById('ageInput').value);
            const gfap = parseFloat(document.getElementById('gfapStrokeInput').value);
            const result = document.getElementById('strokeResult');
            if (isNaN(age) || isNaN(gfap) || age < 1 || age > 120 || gfap < 0 || gfap > 10001) {
                result.innerText = translations[currentLang].invalidInput;
                result.className = 'result warning';
                result.style.display = 'block';
                return;
            }
            let interpretation = '';
            let riskClass = '';
            if (age < 72) {
                if (gfap < 30) {
                    interpretation = strokeInterpretations[currentLang].veryLow;
                    riskClass = 'low-risk';
                } else if (gfap <= 36.8) {
                    interpretation = strokeInterpretations[currentLang].low;
                    riskClass = 'low-risk';
                } else if (gfap < 49.2) {
                    interpretation = strokeInterpretations[currentLang].intermediate;
                    riskClass = 'medium-risk';
                } else if (gfap < 54) {
                    interpretation = strokeInterpretations[currentLang].high;
                    riskClass = 'high-risk';
                } else {
                    interpretation = strokeInterpretations[currentLang].veryHigh;
                    riskClass = 'high-risk';
                }
            } else if (age <= 83) {
                if (gfap < 30) {
                    interpretation = strokeInterpretations[currentLang].veryLow;
                    riskClass = 'low-risk';
                } else if (gfap <= 36.8) {
                    interpretation = strokeInterpretations[currentLang].low;
                    riskClass = 'low-risk';
                } else if (gfap < 107) {
                    interpretation = strokeInterpretations[currentLang].intermediate;
                    riskClass = 'medium-risk';
                } else if (gfap < 149.9) {
                    interpretation = strokeInterpretations[currentLang].high;
                    riskClass = 'high-risk';
                } else {
                    interpretation = strokeInterpretations[currentLang].veryHigh;
                    riskClass = 'high-risk';
                }
            } else {
                if (gfap < 30) {
                    interpretation = strokeInterpretations[currentLang].veryLow;
                    riskClass = 'low-risk';
                } else if (gfap <= 36.8) {
                    interpretation = strokeInterpretations[currentLang].low;
                    riskClass = 'low-risk';
                } else if (gfap < 146.5) {
                    interpretation = strokeInterpretations[currentLang].intermediate;
                    riskClass = 'medium-risk';
                } else {
                    interpretation = strokeInterpretations[currentLang].high;
                    riskClass = 'high-risk';
                }
            }
            result.innerHTML = `<strong>${translations[currentLang].interpretation}:</strong> ${interpretation}`;
            result.className = `result ${riskClass}`;
            result.style.display = 'block';
        }

        // Detect OS and show relevant installation icon
        function detectOS() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            const installIcons = document.getElementById('installIcons');

            // Clear existing icons
            installIcons.innerHTML = '';

            // Check for Android
            if (/android/i.test(userAgent)) {
                installIcons.innerHTML = `
                    <img src="https://upload.wikimedia.org/wikipedia/commons/d/d7/Android_robot.svg" alt="Android" onclick="installAndroid()">
                `;
            }
            // Check for iOS
            else if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                installIcons.innerHTML = `
                    <img src="https://upload.wikimedia.org/wikipedia/commons/f/fa/Apple_logo_black.svg" alt="Apple" onclick="installApple()">
                `;
            }
            // Check for Windows
            else if (/windows/i.test(userAgent)) {
                installIcons.innerHTML = `
                    <img src="https://upload.wikimedia.org/wikipedia/commons/0/0f/Windows_logo_-_2012.svg" alt="Windows" onclick="installWindows()">
                `;
            }
        }

        // Installation functions
        function installAndroid() {
            if (window.matchMedia('(display-mode: standalone)').matches) {
                alert(translations[currentLang].alreadyInstalled);
            } else {
                const deferredPrompt = window.deferredPrompt;
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                }
            }
        }

        function installApple() {
            const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            const modalContent = `
                <p>${translations[currentLang].installIOS}</p>
                <ol>
                    <li>${translations[currentLang].tapShare}</li>
                    <li>${translations[currentLang].tapHomeScreen}</li>
                </ol>
            `;
            if (isSafari) {
                document.getElementById('iosInstallModal').innerHTML = modalContent;
                document.getElementById('iosInstallModal').style.display = 'block';
            } else {
                alert(translations[currentLang].useSafari);
            }
        }

        function installWindows() {
            if (window.matchMedia('(display-mode: standalone)').matches) {
                alert(translations[currentLang].alreadyInstalled);
            } else {
                // Trigger PWA installation
                window.deferredPrompt.prompt();
            }
        }

        // Initialize app
        window.onload = function() {
            document.getElementById('currentYear').innerText = new Date().getFullYear();
            restartApp();
            switchLanguage('en');
            detectOS(); // Detect OS and show relevant installation icon
        };
    </script>

    <!-- iOS Install Modal -->
    <div id="iosInstallModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('iosInstallModal').style.display = 'none'">&times;</span>
            <div id="iosInstallContent"></div>
        </div>
    </div>
</body>
</html>
